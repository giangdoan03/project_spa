<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Chi tiết sản phẩm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
</head>
<body class="bg-gray-100 text-gray-800">
<div id="info" class="p-4 text-center text-sm text-gray-500">Đang tải dữ liệu...</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const pathSegments = window.location.pathname.split("/").filter(Boolean);
        const qrId = pathSegments[0] || null;
        const params = new URLSearchParams(window.location.search);
        const track = params.get("track") || generateTrackCode();
        const scanSource = detectScanSource();

        const infoEl = document.getElementById("info");
        infoEl.innerHTML = "";

        if (!qrId) return (infoEl.textContent = "Không tìm thấy mã QR.");

        try {
            const res = await fetch(`http://api.giang.test/api/qr-codes/detail/${qrId}`);
            const data = await res.json();

            if (!data.qr || !data.target) {
                infoEl.textContent = "QR không tồn tại hoặc không có sản phẩm.";
                return;
            }

            const { qr, target: product } = data;

            // Parse data
            const images = safeParse(product.image, []);
            const avatar = safeParse(product.avatar, [])[0] || "";
            const attributes = safeParse(product.attributes, []);
            const displaySettings = safeParse(safeParse(product.display_settings, "{}"), {});
            const productLinks = displaySettings.productLinks || [];
            const price = parseFloat(product.price || 0).toLocaleString("vi-VN") + " ₫";

            const container = document.createElement("div");
            container.className = "max-w-md mx-auto bg-white p-4 rounded-xl shadow-sm";

            // Images
            if (images.length) container.appendChild(renderImages(images));

            // Title + Avatar
            const header = document.createElement("div");
            header.className = "flex items-center gap-3 mb-3";
            if (avatar) {
                const img = document.createElement("img");
                img.src = avatar;
                img.alt = "avatar";
                img.className = "w-12 h-12 rounded-full object-cover border";
                header.appendChild(img);
            }
            const name = document.createElement("h1");
            name.className = "text-lg font-bold";
            name.textContent = product.name || "(Không có tên)";
            header.appendChild(name);
            container.appendChild(header);

            // Price
            const priceEl = document.createElement("div");
            priceEl.className = "text-red-600 font-semibold text-base mb-3";
            priceEl.textContent = `Giá: ${price}`;
            container.appendChild(priceEl);

            // Description
            const desc = document.createElement("div");
            desc.className = "text-sm leading-relaxed text-gray-700 mb-4";
            desc.innerHTML = product.description || "Không có mô tả sản phẩm.";
            container.appendChild(desc);

            // Attributes
            const attrSection = renderAttributes(attributes);
            if (attrSection) container.appendChild(attrSection);

            // Buy buttons
            const buyBtn = renderBuyButtons(productLinks);
            if (buyBtn) container.appendChild(buyBtn);

            // Gắn vào info
            infoEl.appendChild(container);

            // Swiper init
            if (images.length) {
                new Swiper(".mySwiper", {
                    pagination: { el: ".swiper-pagination", clickable: true }
                });
            }

            // Tracking
            await fetch("http://api.giang.test/api/qr-codes/track", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    code: qr.qr_id,
                    track,
                    short_code: qr.short_code || qrId,
                    qr_url: qr.qr_url,
                    type: qr.target_type,
                    target_id: qr.target_id,
                    scan_source: scanSource
                })
            });
        } catch (err) {
            infoEl.textContent = "Không thể kết nối tới máy chủ.";
            console.error(err);
        }

        function safeParse(json, fallback = {}) {
            try {
                return typeof json === "string" ? JSON.parse(json) : json;
            } catch {
                return fallback;
            }
        }

        function renderImages(images) {
            const wrapper = document.createElement("div");
            wrapper.className = "swiper mySwiper rounded-lg overflow-hidden mb-4 h-44";

            const swiperWrapper = document.createElement("div");
            swiperWrapper.className = "swiper-wrapper";

            images.forEach((img) => {
                const slide = document.createElement("div");
                slide.className = "swiper-slide";
                slide.innerHTML = `<img src="${img}" class="w-full h-full object-cover" />`;
                swiperWrapper.appendChild(slide);
            });

            const pagination = document.createElement("div");
            pagination.className = "swiper-pagination text-center mt-2";

            wrapper.appendChild(swiperWrapper);
            wrapper.appendChild(pagination);
            return wrapper;
        }

        function renderAttributes(attributes) {
            if (!attributes.length) return null;
            const wrapper = document.createElement("div");
            wrapper.className = "mb-4";

            const title = document.createElement("h2");
            title.className = "font-semibold mb-2";
            title.textContent = "Thông số kỹ thuật:";
            wrapper.appendChild(title);

            const ul = document.createElement("ul");
            ul.className = "list-disc list-inside text-sm text-gray-700";
            attributes.forEach(attr => {
                const li = document.createElement("li");
                li.textContent = `${attr.name}: ${attr.value}`;
                ul.appendChild(li);
            });

            wrapper.appendChild(ul);
            return wrapper;
        }

        function renderBuyButtons(links) {
            const validLinks = links.filter(l => l.url?.startsWith("http"));
            if (!validLinks.length) return null;

            const wrapper = document.createElement("div");
            wrapper.className = "flex flex-wrap gap-2 mb-2";

            validLinks.forEach(link => {
                const a = document.createElement("a");
                a.href = link.url;
                a.target = "_blank";
                a.className = "px-4 py-2 bg-blue-600 text-white rounded text-sm";
                a.textContent = link.platform || "Mua ngay";
                wrapper.appendChild(a);
            });

            return wrapper;
        }

        function generateTrackCode() {
            return "auto_" + Math.random().toString(36).substring(2, 10);
        }

        function detectScanSource() {
            const ua = navigator.userAgent.toLowerCase();
            if (ua.includes("zalo")) return "zalo_scan";
            if (ua.includes("fb")) return "facebook_app";
            if (ua.includes("chrome")) return "chrome";
            if (ua.includes("safari") && !ua.includes("chrome")) return "safari";
            if (ua.includes("firefox")) return "firefox";
            if (ua.includes("edge")) return "edge";
            if (ua.includes("android")) return "android_browser";
            if (ua.includes("iphone") || ua.includes("ipad")) return "ios_browser";
            return "unknown";
        }
    });
</script>
</body>
</html>
