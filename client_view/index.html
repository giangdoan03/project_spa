<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Chi ti·∫øt s·∫£n ph·∫©m</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.min.js"></script>
    <style>
        .swiper {
            width: 100%;
            height: 25rem; /* t∆∞∆°ng ƒë∆∞∆°ng h-64 */
        }
        .swiper-slide img {
            object-fit: contain;
            max-height: 100%;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-800 h-screen">
<div id="info" class="max-w-md mx-auto bg-white shadow-lg overflow-hidden h-screen flex flex-col"></div>

<!-- Handlebars template -->
<script id="product-template" type="text/x-handlebars-template">
    {{#if images.length}}
    {{#if (gt images.length 1)}}
    <div class="swiper mySwiper">
        <div class="swiper-wrapper">
            {{#each images}}
            <div class="swiper-slide">
                <img src="{{this}}" class="w-full object-contain" style="max-height: 100vh;" alt="slide">
            </div>
            {{/each}}
        </div>
        <div class="swiper-pagination"></div>
    </div>
    {{else}}
    <img src="{{images.[0]}}" class="w-full object-contain" style="max-height: 100vh;" alt="·∫¢nh s·∫£n ph·∫©m">
    {{/if}}
    {{/if}}

    <div class="p-4 overflow-y-auto flex-1">
        <h1 class="text-xl font-semibold">{{product.name}}</h1>
        <p class="text-green-700 font-bold text-lg mt-1">{{price}}</p>
        <span class="text-xs bg-gray-200 px-2 py-1 rounded-full inline-block mt-1">k√≠ch th∆∞·ªõc: {{product.size}}</span>

        <div class="mt-4 bg-green-600 text-white px-4 py-2 rounded-md font-semibold">Th√¥ng tin</div>
        <div class="mt-4">
            <p class="font-medium">{{product.name}}</p>
            <p class="text-sm text-gray-600">{{{product.description}}}</p>
        </div>

        <div class="mt-6 bg-green-100 p-4 rounded-lg">
            <h2 class="font-semibold mb-2">Company</h2>
            <div class="flex items-center gap-3">
                <img src="{{avatar}}" class="w-10 h-10 rounded" alt="logo">
                <div>
                    <p class="font-medium">{{product.company_name}}</p>
                    <p class="text-sm text-gray-600">üì± {{product.phone}}</p>
                </div>
            </div>
        </div>

        {{#if related.length}}
        <div class="mt-6">
            <h2 class="font-semibold mb-2">Related products</h2>
            <div class="flex gap-3">
                {{#each related}}
                <div class="text-center">
                    <img src="{{this.image}}" class="border rounded-lg" alt="">
                    <p class="text-sm text-gray-500">x{{this.count}}</p>
                </div>
                {{/each}}
            </div>
        </div>
        {{/if}}

        {{#if productLinks.length}}
        <div class="mt-4 flex flex-wrap gap-2">
            {{#each productLinks}}
            <a href="{{this.url}}" target="_blank" class="px-4 py-2 bg-blue-600 text-white rounded text-sm">
                {{this.platform}}
            </a>
            {{/each}}
        </div>
        {{/if}}

        <div class="mt-6 text-center text-xs text-gray-500">
            <p><img src="https://placehold.co/16x16?text=üîó" class="inline-block mr-1" />Powered by <strong>iCheckQR</strong></p>
        </div>
    </div>
</script>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
    Handlebars.registerHelper("gt", function (a, b) {
        return a > b;
    });

    document.addEventListener("DOMContentLoaded", async () => {
        const qrId = window.location.pathname.split("/").filter(Boolean)[0];
        const params = new URLSearchParams(window.location.search);
        const track = params.get("track") || generateTrackCode();
        const infoEl = document.getElementById("info");

        if (!qrId) {
            infoEl.innerHTML = `<p class="text-center p-4">Kh√¥ng t√¨m th·∫•y m√£ QR</p>`;
            return;
        }

        try {
            const res = await fetch(`http://api.giang.test/api/qr-codes/detail/${qrId}`);
            const data = await res.json();
            if (!data.qr || !data.target) {
                infoEl.innerHTML = `<p class="text-center p-4">QR kh√¥ng t·ªìn t·∫°i ho·∫∑c kh√¥ng c√≥ s·∫£n ph·∫©m.</p>`;
                return;
            }

            const { qr, target: product } = data;
            const images = tryParseImages(product.image);
            const mainImage = images[0] || "";

            let avatar = "";
            try {
                const rawAvatar = product.avatar;
                const parsed = typeof rawAvatar === "string" ? JSON.parse(rawAvatar) : rawAvatar;
                avatar = Array.isArray(parsed) ? cleanUrl(parsed[0]) : cleanUrl(parsed);
            } catch {
                avatar = "";
            }

            const attributes = safeParse(product.attributes, []);
            const settings = safeParse(safeParse(product.display_settings, "{}"), {});
            const productLinks = settings.productLinks || [];
            const related = Array.isArray(settings.relatedProducts) ? settings.relatedProducts : [];
            const price = parseFloat(product.price || 0).toLocaleString("vi-VN") + " ‚Ç´";

            const template = Handlebars.compile(document.getElementById("product-template").innerHTML);
            infoEl.innerHTML = template({ qr, product, images, mainImage, avatar, attributes, settings, productLinks, related, price });

            if (images.length > 1) {
                requestAnimationFrame(() => {
                    new Swiper(".mySwiper", {
                        pagination: {
                            el: ".swiper-pagination",
                            clickable: true,
                        },
                    });
                });
            }

            await fetch("http://api.giang.test/api/qr-codes/track", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    code: qr.qr_id,
                    track,
                    short_code: qr.short_code || qrId,
                    qr_url: qr.qr_url,
                    type: qr.target_type,
                    target_id: qr.target_id,
                    scan_source: detectScanSource()
                })
            });

        } catch (err) {
            infoEl.innerHTML = `<p class="text-center p-4">Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi m√°y ch·ªß.</p>`;
            console.error(err);
        }

        function cleanUrl(url) {
            return url?.replace(/^"+|"+$/g, "").replace(/\\/g, "").trim() || "";
        }

        function safeParse(input, fallback = []) {
            try {
                return typeof input === "string" ? JSON.parse(input) : input;
            } catch {
                return fallback;
            }
        }

        function tryParseImages(raw) {
            if (!raw || typeof raw !== "string") return [];
            try {
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed)
                    ? parsed.map(cleanUrl).filter(url => isValidImage(url))
                    : [];
            } catch {
                return raw.split(",").map(cleanUrl).filter(url => isValidImage(url));
            }
        }

        function isValidImage(url) {
            return /^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)$/i.test(url);
        }


        function generateTrackCode() {
            return "auto_" + Math.random().toString(36).substring(2, 10);
        }

        function detectScanSource() {
            const ua = navigator.userAgent.toLowerCase();
            if (ua.includes("zalo")) return "zalo_scan";
            if (ua.includes("fb")) return "facebook_app";
            if (ua.includes("chrome")) return "chrome";
            if (ua.includes("safari") && !ua.includes("chrome")) return "safari";
            if (ua.includes("firefox")) return "firefox";
            if (ua.includes("edge")) return "edge";
            if (ua.includes("android")) return "android_browser";
            if (ua.includes("iphone") || ua.includes("ipad")) return "ios_browser";
            return "unknown";
        }
    });
</script>
</body>
</html>
