<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Chi tiết sản phẩm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
</head>
<body class="bg-gray-100 text-gray-800">
<div id="info" class="p-4 text-center text-sm text-gray-500">Đang tải dữ liệu...</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const pathSegments = window.location.pathname.split("/").filter(Boolean);
        const qrId = pathSegments[0] || null;
        const params = new URLSearchParams(window.location.search);
        const track = params.get("track") || generateTrackCode();
        const scanSource = detectScanSource();

        if (!qrId) {
            document.getElementById("info").innerHTML = "Không tìm thấy mã QR.";
            return;
        }

        fetch(`http://api.giang.test/api/qr-codes/detail/${qrId}`)
            .then(res => res.json())
            .then(data => {
                if (!data.qr || !data.target) {
                    document.getElementById("info").innerHTML = "QR không tồn tại hoặc không có sản phẩm.";
                    return;
                }

                const qr = data.qr;
                const product = data.target;

                // Parse dữ liệu
                let images = [];
                try { images = JSON.parse(product.image); } catch {}
                let avatar = "";
                try {
                    const parsed = JSON.parse(product.avatar);
                    if (Array.isArray(parsed)) avatar = parsed[0];
                } catch {}

                let attributes = [];
                try { attributes = JSON.parse(product.attributes); } catch {}

                let displaySettings = {};
                try {
                    displaySettings = JSON.parse(JSON.parse(product.display_settings));
                } catch {}

                const productLinks = displaySettings.productLinks || [];
                const price = parseFloat(product.price || 0).toLocaleString("vi-VN") + " ₫";

                // HTML render
                let html = `<div class="max-w-md mx-auto bg-white p-4 rounded-xl shadow-sm">`;

                if (images.length > 0) {
                    html += `
              <div class="swiper mySwiper rounded-lg overflow-hidden mb-4 h-44">
                <div class="swiper-wrapper">
                  ${images.map(img => `<div class="swiper-slide"><img src="${img}" class="w-full h-full object-cover" /></div>`).join('')}
                </div>
                <div class="swiper-pagination text-center mt-2"></div>
              </div>
            `;
                }

                html += `
            <div class="flex items-center gap-3 mb-3">
              ${avatar ? `<img src="${avatar}" class="w-12 h-12 rounded-full object-cover border" alt="avatar">` : ''}
              <h1 class="text-lg font-bold">${product.name || '(Không có tên)'}</h1>
            </div>
            <div class="text-red-600 font-semibold text-base mb-3">Giá: ${price}</div>
            <div class="text-sm leading-relaxed text-gray-700 mb-4">${product.description || 'Không có mô tả sản phẩm.'}</div>
          `;

                if (attributes.length > 0) {
                    html += `<div class="mb-4"><h2 class="font-semibold mb-2">Thông số kỹ thuật:</h2><ul class="list-disc list-inside text-sm text-gray-700">`;
                    attributes.forEach(attr => {
                        html += `<li>${attr.name}: ${attr.value}</li>`;
                    });
                    html += `</ul></div>`;
                }

                if (Array.isArray(productLinks) && productLinks.some(p => p.url)) {
                    html += `<div class="flex flex-wrap gap-2 mb-2">`;
                    productLinks.forEach(link => {
                        if (link.url && link.url.startsWith('http')) {
                            html += `<a href="${link.url}" target="_blank" class="px-4 py-2 bg-blue-600 text-white rounded text-sm">${link.platform}</a>`;
                        }
                    });
                    html += `</div>`;
                }

                html += `</div>`;
                document.getElementById("info").innerHTML = html;

                if (images.length) {
                    new Swiper(".mySwiper", {
                        pagination: { el: ".swiper-pagination", clickable: true }
                    });
                }

                // Gửi tracking
                fetch("http://api.giang.test/api/qr-codes/track", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        code: qr.qr_id,
                        track: track,
                        short_code: qr.short_code || qrId,
                        qr_url: qr.qr_url,
                        type: qr.target_type,
                        target_id: qr.target_id,
                        scan_source: scanSource
                    })
                }).then(res => res.json()).then(console.log).catch(console.error);
            })
            .catch(() => {
                document.getElementById("info").innerHTML = "Không thể kết nối tới máy chủ.";
            });

        function generateTrackCode() {
            return "auto_" + Math.random().toString(36).substring(2, 10);
        }

        function detectScanSource() {
            const ua = navigator.userAgent.toLowerCase();
            if (ua.includes("zalo")) return "zalo_scan";
            if (ua.includes("fb")) return "facebook_app";
            if (ua.includes("chrome")) return "chrome";
            if (ua.includes("safari") && !ua.includes("chrome")) return "safari";
            if (ua.includes("firefox")) return "firefox";
            if (ua.includes("edge")) return "edge";
            if (ua.includes("android")) return "android_browser";
            if (ua.includes("iphone") || ua.includes("ipad")) return "ios_browser";
            return "unknown";
        }
    });
</script>
</body>
</html>
